var MusicTempo=function(e){"use strict";function t(e,t){const n=e.length,r=Math.round(Math.log(n)/Math.log(2)),o=2*Math.PI;if(n!=1<<r)throw new Error("FFT data must be power of 2");let a,l=0;for(let r=0;r<n-1;r++){if(r<l){let n=e[l];e[l]=e[r],e[r]=n,n=t[l],t[l]=t[r],t[r]=n}let o=n/2;for(;o>=1&&o-1<l;)l-=o,o/=2;l+=o}for(let i=1;i<=r;i++){a=1<<i;let r=1,s=0,h=o/a,c=Math.cos(h),d=-1*Math.sin(h),f=a/2;for(l=0;l<f;l++){for(let o=l;o<n;o+=a){let n=o+f,a=r*e[n]-s*t[n],l=r*t[n]+s*e[n];e[n]=e[o]-a,t[n]=t[o]-l,e[o]+=a,t[o]+=l}let o=r;r=c*r-d*s,s=c*s+d*o}}for(let n=0;n<e.length;n++){let r=e[n]*e[n]+t[n]*t[n];e[n]=r}for(let t=0;t<e.length;t++)e[t]=Math.sqrt(e[t])}const n=e=>new Array(e).fill(0);const r={bufferSize:2048,hopSize:441,samplingRate:44100};function o(e,{bufferSize:o=2048,hopSize:a=441}=r){let l=Math.floor(Math.log(o)/Math.LN2);if(Math.pow(2,l)!==o)throw"Invalid buffer size ("+o+"), must be power of 2";const i=function(e){const t=1/e/.54,n=Math.sqrt(e),r=2*Math.PI/e;let o=[];for(let a=0;a<e;a++)o[a]=n*(t*(.5434782608695652-.45652173913043476*Math.cos(r*a)));return o}(o);let s=[];const h=o/2+1;let c=new Array(h);c.fill(0);let d=new Array(o);const f=e.length;let I=n(o-a);const m=n(o-(I.length+f)%a),p=[...I,...e,...m];for(let e=0;e<f;e+=a){let n=e+o;const r=[];let a=0;for(let t=e;t<n;t++)r[a]=i[a]*p[t],a++;d.fill(0),t(r,d);let l=0;for(let e=0;e<h;e++){let t=r[e]-c[e];l+=t<0?0:t}s.push(l),c=r}return s}const a={decayRate:.84,peakFindingWindow:6,meanWndMultiplier:3,peakThreshold:.35};const l={widthTreshold:.025,maxIOI:2.5,minIOI:.07};const i={widthTreshold:.025};const s={widthTreshold:.025,maxTempos:10};const h={widthTreshold:.025,minBeatInterval:.3,maxBeatInterval:1};const c={expiryTime:10,toleranceWndInner:.04,toleranceWndPre:.15,toleranceWndPost:.3,correctionFactor:50,maxChange:.2,penaltyFactor:.5};class d{constructor(e,t,n,r,o=c){this.expiryTime=o.expiryTime||10,this.toleranceWndInner=o.toleranceWndInner||.04,this.toleranceWndPre=o.toleranceWndPre||.15,this.toleranceWndPost=o.toleranceWndPost||.3,this.toleranceWndPre*=e||0,this.toleranceWndPost*=e||0,this.correctionFactor=o.correctionFactor||50,this.maxChange=o.maxChange||.2,this.penaltyFactor=o.penaltyFactor||.5,this.beatInterval=e,this.initialBeatInterval=e,this.beatTime=t||0,this.totalBeatCount=1,this.events=[t||0],this.score=n,this.agentListRef=r}considerEvent(e,t){var n;if(e-this.events[this.events.length-1]>this.expiryTime)return this.score=-1,!1;let r=Math.round((e-this.beatTime)/this.beatInterval),o=e-this.beatTime-r*this.beatInterval;return r>0&&o>=-this.toleranceWndPre&&o<=this.toleranceWndPost&&(Math.abs(o)>this.toleranceWndInner&&(null===(n=this.agentListRef)||void 0===n||n.push(this.clone())),this.acceptEvent(e,t,o,r),!0)}acceptEvent(e,t,n,r){this.beatTime=e,this.events.push(e);let o=n/this.correctionFactor;Math.abs(this.initialBeatInterval-this.beatInterval-o)<this.maxChange*this.initialBeatInterval&&(this.beatInterval+=o),this.totalBeatCount+=r;let a=n>0?n/this.toleranceWndPost:n/-this.toleranceWndPre,l=1-this.penaltyFactor*a;this.score+=t*l}fillBeats(){let e,t,n,r;e=0,this.events.length>2&&(e=this.events[0]);for(let o=0;o<this.events.length;o++){t=this.events[o],r=Math.round((t-e)/this.beatInterval-.01),n=(t-e)/r;let a=0;for(;r>1;r--)e+=n,this.events.splice(o+a,0,e),a++;e=t}}clone(){let e=new d;return e.beatInterval=this.beatInterval,e.initialBeatInterval=this.initialBeatInterval,e.beatTime=this.beatTime,e.totalBeatCount=this.totalBeatCount,e.events=this.events.slice(),e.expiryTime=this.expiryTime,e.toleranceWndInner=this.toleranceWndInner,e.toleranceWndPre=this.toleranceWndPre,e.toleranceWndPost=this.toleranceWndPost,e.correctionFactor=this.correctionFactor,e.maxChange=this.maxChange,e.penaltyFactor=this.penaltyFactor,e.score=this.score,e.agentListRef=this.agentListRef,e}}const f={initPeriod:5,thresholdBI:.02,thresholdBT:.04,expiryTime:10,toleranceWndInner:.04,toleranceWndPre:.15,toleranceWndPost:.3,correctionFactor:50,maxChange:.2,penaltyFactor:.5};const I={timeStep:.01,bufferSize:2048,hopSize:441,decayRate:.84,peakFindingWindow:6,meanWndMultiplier:3,peakThreshold:.35,widthTreshold:.025,maxIOI:2.5,minIOI:.07,maxTempos:10,minBeatInterval:.3,maxBeatInterval:1,initPeriod:5,thresholdBI:.02,thresholdBT:.04,expiryTime:10,toleranceWndInner:.04,toleranceWndPre:.15,toleranceWndPost:.3,correctionFactor:50,maxChange:.2,penaltyFactor:.5};function m(e,{timeStep:t=.01,bufferSize:n=2048,hopSize:r=441,decayRate:c=.84,peakFindingWindow:m=6,meanWndMultiplier:p=3,peakThreshold:u=.35,widthTreshold:g=.025,maxIOI:v=2.5,minIOI:T=.07,maxTempos:W=10,minBeatInterval:b=.3,maxBeatInterval:x=1,initPeriod:M=5,thresholdBI:P=.02,thresholdBT:y=.04,expiryTime:w=10,toleranceWndInner:F=.04,toleranceWndPre:B=.15,toleranceWndPost:S=.3,correctionFactor:C=50,maxChange:z=.2,penaltyFactor:O=.5}=I){const k=function(e){if(0==e.length)throw"Array is empty";let t=0,n=0;const r=[];for(let r=0;r<e.length;r++)t+=e[r],n+=e[r]*e[r];const o=t/e.length;let a=Math.sqrt((n-t*o)/e.length);0==a&&(a=1);for(let t=0;t<e.length;t++)r[t]=(e[t]-o)/a;return r}(o(e,{hopSize:r,bufferSize:n})),R=function(e,{decayRate:t=.84,peakFindingWindow:n=6,meanWndMultiplier:r=3,peakThreshold:o=.35}=a){const l=e.length,i=e;let s=i[0],h=[];for(let e=0;e<l;e++){if(s=t*s+(1-t)*i[e],i[e]<s)continue;let a=e-n,c=e+n+1;a<0&&(a=0),c>l&&(c=l),s<i[e]&&(s=i[e]);let d=!0;for(let t=a;t<c;t++)i[t]>i[e]&&(d=!1);if(d){let t=e-n*r,a=e+n;t<0&&(t=0),a>l&&(a=l);let s=0,c=a-t;for(let e=t;e<a;e++)s+=i[e];i[e]>s/c+o&&h.push(e)}}if(h.length<2)throw"Fail to find peaks";return h}(k,{decayRate:c,peakFindingWindow:m,meanWndMultiplier:p,peakThreshold:u}),E=R.map((e=>e*t)),L=function(e,{widthTreshold:t=.025,maxIOI:n=2.5,minIOI:r=.07}=l){const o=e.length;let a=[],i=[],s=0;for(let l=0;l<o-1;l++)for(let h=l+1;h<o;h++){let o=e[h]-e[l];if(o<r)continue;if(o>n)break;let c=0;for(;c<s;c++)if(Math.abs(a[c]-o)<t){Math.abs(a[c+1]-o)<Math.abs(a[c]-o)&&c<s-1&&c++,a[c]=(a[c]*i[c]+o)/(i[c]+1),i[c]++;break}if(c==s){for(s++;c>0&&a[c-1]>o;c--)a[c]=a[c-1],i[c]=i[c-1];a[c]=o,i[c]=1}}if(0==s)throw"Fail to find IOIs";return a.length=s,i.length=s,{clIntervals:a,clSizes:i}}(E,{widthTreshold:g,maxIOI:v,minIOI:T}),A=function(e,{widthTreshold:t=.025,maxTempos:n=10}=s){let r=e.clIntervals,o=e.clSizes,a=[],l=[],i=r.length;for(let e=0;e<i;e++)a[e]=10*o[e],l[e]={score:a[e],idx:e};if(l.sort(((e,t)=>t.score-e.score)),l.length>n){for(let e=n-1;e<l.length-1&&l[e].score==l[e+1].score;e++)n++;l.length=n}const h=l.map((e=>e.idx));for(let e=0;e<i;e++)for(let n=e+1;n<i;n++){let l,i,s=r[e]/r[n],h=s<1;l=h?Math.round(1/s):Math.round(s),l<2||l>8||(i=h?Math.abs(r[e]*l-r[n]):Math.abs(r[e]-r[n]*l),i>=(h?t:t*l)||(l=l>=5?1:6-l,a[e]+=l*o[n],a[n]+=l*o[e]))}return{clScores:a,clScoresIdxs:h}}(function(e,{widthTreshold:t=.025}=i){let n=e.clIntervals,r=e.clSizes,o=n.length;for(let e=0;e<o;e++)for(let a=e+1;a<o;a++)if(Math.abs(n[e]-n[a])<t){n[e]=(n[e]*r[e]+n[a]*r[a])/(r[e]+r[a]),r[e]=r[e]+r[a],--o;for(let e=a+1;e<=o;e++)n[e-1]=n[e],r[e-1]=r[e]}return n.length=o,r.length=o,{clIntervals:n,clSizes:r}}(L,{widthTreshold:g}),{widthTreshold:g,maxTempos:W}),j=function({clIntervals:e,clScores:t,clScoresIdxs:n},{widthTreshold:r=.025,minBeatInterval:o=.3,maxBeatInterval:a=1}=h){const l=[];let i=e.length;for(let s=0;s<n.length;s++){let h,c,d=n[s],f=e[d]*t[d],I=t[d];for(let n=0;n<i;n++){if(n==d)continue;let o=e[d]/e[n],a=o<1,l=a?Math.round(1/o):Math.round(o);l<2||l>8||(a?(h=Math.abs(e[d]*l-e[n]),c=r):(h=Math.abs(e[d]-l*e[n]),c=r*l),h>=c||(f+=a?e[n]/l*t[n]:e[n]*l*t[n],I+=t[n]))}let m=f/I;for(;m<o;)m*=2;for(;m>a;)m/=2;l.push(m)}return l}(Object.assign(Object.assign({},L),{clScores:A.clScores,clScoresIdxs:A.clScoresIdxs}),{widthTreshold:g,minBeatInterval:b,maxBeatInterval:x}),q=Math.min(...k);let _,N=function(e,t,n,{initPeriod:r=5,thresholdBI:o=.02,thresholdBT:a=.04,expiryTime:l=10,toleranceWndInner:i=.04,toleranceWndPre:s=.15,toleranceWndPost:h=.3,correctionFactor:c=50,maxChange:I=.2,penaltyFactor:m=.5}=f){let p=[];function u(){p.sort(((e,t)=>e.beatInterval-t.beatInterval));const e=p.length;for(let t=0;t<e;t++)if(!(p[t].score<0))for(let n=t+1;n<e&&!(p[n].beatInterval-p[t].beatInterval>o);n++)Math.abs(p[n].beatTime-p[t].beatTime)>a||(p[t].score<p[n].score?p[t].score=-1:p[n].score=-1);for(let t=e-1;t>=0;t--)p[t].score<0&&p.splice(t,1)}for(let r=0;r<n.length;r++)p.push(new d(n[r],e[0],t[0],p,{expiryTime:l,toleranceWndInner:i,toleranceWndPre:s,toleranceWndPost:h,correctionFactor:c,maxChange:I,penaltyFactor:m}));let g=1;for(u();e[g]<r;){let n=p.length,r=-1,o=!0;for(let a=0;a<n;a++)p[a].beatInterval!=r&&(o||p.push(new d(r,e[g],t[g],p,{expiryTime:l,toleranceWndInner:i,toleranceWndPre:s,toleranceWndPost:h,correctionFactor:c,maxChange:I,penaltyFactor:m})),r=p[a].beatInterval,o=!1),o=p[a].considerEvent(e[g],t[g])||o;u(),g++}const v=e.length;for(let n=g;n<v;n++){let r=p.length;for(let o=0;o<r;o++)p[o].considerEvent(e[n],t[n]);u()}return p}(E,R.map((e=>k[e]-q)),j,{initPeriod:M,thresholdBI:P,thresholdBT:y,expiryTime:w,toleranceWndInner:F,toleranceWndPre:B,toleranceWndPost:S,correctionFactor:C,maxChange:z,penaltyFactor:O}),D=-1/0;for(let e of N)e.score&&e.score>D&&(_=e,D=e.score);if(!_)throw new Error("Tempo extraction failed");return _.fillBeats(),{tempo:60/_.beatInterval,beatInterval:_.beatInterval,beats:_.events}}return e.default=m,e.extractTempo=m,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
